<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Solana Protocol Design for Agent and MCP Server Registries</title>
    
    <!-- External libraries with fallback mechanisms -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github-gist.min.css">
    
    <!-- Load libraries in the correct order with fallbacks -->
    <script>
        // Function to load script with fallback
        function loadScript(src, fallbackSrc, callback) {
            var script = document.createElement('script');
            script.src = src;
            script.onload = callback;
            script.onerror = function() {
                console.warn('Failed to load script from primary source:', src);
                if (fallbackSrc) {
                    console.log('Trying fallback source:', fallbackSrc);
                    var fallbackScript = document.createElement('script');
                    fallbackScript.src = fallbackSrc;
                    fallbackScript.onload = callback;
                    fallbackScript.onerror = function() {
                        console.error('Failed to load script from fallback source:', fallbackSrc);
                    };
                    document.head.appendChild(fallbackScript);
                }
            };
            document.head.appendChild(script);
        }

        // Load highlight.js first
        loadScript(
            'https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js',
            'https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.8.0/build/highlight.min.js',
            function() {
                // Then load Rust language support
                loadScript(
                    'https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/rust.min.js',
                    'https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.8.0/build/languages/rust.min.js',
                    function() {
                        // Initialize highlight.js
                        if (typeof hljs !== 'undefined') {
                            hljs.configure({
                                ignoreUnescapedHTML: true
                            });
                            console.log('highlight.js loaded successfully');
                        } else {
                            console.error('highlight.js failed to initialize');
                        }
                    }
                );
            }
        );

        // Load marked.js
        loadScript(
            'https://cdnjs.cloudflare.com/ajax/libs/marked/4.3.0/marked.min.js',
            'https://cdn.jsdelivr.net/npm/marked@4.3.0/marked.min.js',
            function() {
                console.log('marked.js loaded successfully');
            }
        );

        // Load DOMPurify
        loadScript(
            'https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.5/purify.min.js',
            'https://cdn.jsdelivr.net/npm/dompurify@3.0.5/dist/purify.min.js',
            function() {
                console.log('DOMPurify loaded successfully');
            }
        );
    </script>
    
    <style>
        /* Base styles */
        :root {
            --bg-color: #f8f8f8;
            --text-color: #333;
            --border-color: #737373;
            --header-bg: #e5e5e5;
            --tag-bg: #a3a3a3;
            --hover-bg: #f0f0f0;
            --code-bg: #f5f5f5;
            --box-shadow: 2px 2px 0px #a3a3a3;
            --info-box-bg: #e5e5e5;
        }
        
        body {
            font-family: "Courier New", Courier, monospace;
            line-height: 1.6;
            margin: 0;
            padding: 0;
            background-color: var(--bg-color);
            color: var(--text-color);
        }
        
        /* Layout */
        .container {
            display: flex;
            min-height: 100vh;
        }
        
        /* Sidebar */
        .sidebar {
            width: 280px;
            background-color: var(--header-bg);
            border-right: 1px solid var(--border-color);
            padding: 1rem;
            overflow-y: auto;
            position: fixed;
            height: 100vh;
            transition: transform 0.3s ease;
            z-index: 100;
        }
        
        .sidebar-hidden {
            transform: translateX(-280px);
        }
        
        .sidebar-toggle {
            position: fixed;
            top: 10px;
            left: 10px;
            z-index: 101;
            background-color: var(--header-bg);
            border: 1px solid var(--border-color);
            padding: 5px 10px;
            cursor: pointer;
            display: none;
        }
        
        .sidebar h2 {
            margin-top: 0;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid var(--border-color);
        }
        
        .search-container {
            margin-bottom: 1rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border-color);
        }
        
        .search-input {
            width: 100%;
            padding: 0.5rem;
            font-family: "Courier New", Courier, monospace;
            border: 1px solid var(--border-color);
            background-color: var(--bg-color);
        }
        
        .search-results {
            margin-top: 0.5rem;
            max-height: 200px;
            overflow-y: auto;
            display: none;
        }
        
        .search-results.visible {
            display: block;
        }
        
        .search-result-item {
            padding: 0.5rem;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
        }
        
        .search-result-item:hover {
            background-color: var(--hover-bg);
        }
        
        .chapter-list {
            list-style-type: none;
            padding: 0;
            margin: 0;
        }
        
        .chapter-list li {
            margin-bottom: 0.5rem;
        }
        
        .chapter-list a {
            display: block;
            padding: 0.5rem;
            text-decoration: none;
            color: var(--text-color);
            border: 1px solid transparent;
        }
        
        .chapter-list a:hover, .chapter-list a.active {
            background-color: var(--hover-bg);
            border: 1px solid var(--border-color);
        }
        
        .chapter-toggle {
            display: inline-block;
            width: 20px;
            text-align: center;
            cursor: pointer;
        }
        
        .subchapter-list {
            list-style-type: none;
            padding-left: 1.5rem;
            margin: 0.5rem 0;
            display: none;
        }
        
        .subchapter-list.visible {
            display: block;
        }
        
        /* Main content */
        .content {
            flex: 1;
            padding: 2rem;
            margin-left: 280px;
            transition: margin-left 0.3s ease;
        }
        
        .content-full {
            margin-left: 0;
        }
        
        /* Header */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 0;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 2rem;
        }
        
        .header h1 {
            margin: 0;
        }
        
        .header-controls {
            display: flex;
            gap: 1rem;
        }
        
        /* Navigation controls */
        .navigation-controls {
            display: flex;
            justify-content: space-between;
            margin-top: 2rem;
            padding-top: 1rem;
            border-top: 1px solid var(--border-color);
        }
        
        /* Loading spinner */
        .spinner {
            display: none;
            margin: 2rem auto;
            text-align: center;
        }
        
        .spinner.visible {
            display: block;
        }
        
        /* Error message */
        .error-message {
            background-color: #ffdddd;
            border: 1px solid #f44336;
            padding: 1rem;
            margin: 1rem 0;
            display: none;
        }
        
        .error-message.visible {
            display: block;
        }
        
        /* Button styles */
        button {
            background-color: var(--header-bg);
            border: 1px solid var(--border-color);
            padding: 0.5rem 1rem;
            cursor: pointer;
            font-family: "Courier New", Courier, monospace;
        }
        
        button:hover {
            background-color: var(--hover-bg);
        }
        
        /* Table styles */
        .table-corporate {
            width: 100%;
            border-collapse: collapse;
            margin: 1rem 0;
        }
        
        .table-corporate th {
            background-color: var(--tag-bg);
            color: white;
            text-align: left;
            padding: 0.5rem;
            border: 1px solid var(--border-color);
        }
        
        .table-corporate td {
            padding: 0.5rem;
            border: 1px solid var(--border-color);
        }
        
        .table-corporate tr:nth-child(even) {
            background-color: var(--hover-bg);
        }
        
        /* Card and info box styles */
        .card {
            background-color: var(--code-bg);
            border: 1px solid var(--border-color);
            padding: 1rem;
            margin: 1rem 0;
            box-shadow: var(--box-shadow);
        }
        
        .info-box {
            background-color: var(--info-box-bg);
            border: 1px dashed var(--border-color);
            padding: 1rem;
            margin: 1rem 0;
        }
        
        /* Hybrid box for two-column layouts */
        .hybrid-box {
            display: flex;
            margin: 1rem 0;
            border: 1px solid var(--border-color);
        }
        
        .hybrid-box-column {
            flex: 1;
            padding: 1rem;
            background-color: var(--code-bg);
        }
        
        .hybrid-box-column:first-child {
            border-right: 1px solid var(--border-color);
        }
        
        .hybrid-box-connector {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0 1rem;
        }
        
        /* Flow steps and arrows */
        .flow-step {
            background-color: var(--code-bg);
            border: 1px solid var(--border-color);
            padding: 0.5rem 1rem;
            margin: 0.5rem 0;
            text-align: center;
        }
        
        .flow-arrow {
            text-align: center;
            margin: 0.5rem 0;
        }
        
        /* Code styles */
        pre {
            background-color: var(--code-bg);
            border: 1px solid var(--border-color);
            padding: 1rem;
            overflow-x: auto;
            position: relative;
            margin: 1rem 0;
        }
        
        code {
            font-family: "Courier New", Courier, monospace;
        }
        
        .code-tag {
            display: inline-block;
            background-color: var(--tag-bg);
            padding: 0.1rem 0.3rem;
            margin: 0 0.2rem;
            border-radius: 0;
        }
        
        /* Code buttons */
        .code-buttons {
            position: absolute;
            top: 5px;
            right: 5px;
            display: flex;
            gap: 5px;
        }
        
        .copy-button, .execute-button {
            background-color: var(--header-bg);
            border: 1px solid var(--border-color);
            padding: 2px 5px;
            font-size: 0.8rem;
            cursor: pointer;
        }
        
        .copy-button:hover, .execute-button:hover {
            background-color: var(--hover-bg);
        }
        
        /* ASCII diagram styles */
        .ascii-diagram {
            font-family: "Courier New", Courier, monospace;
            white-space: pre;
            line-height: 1.2;
            background-color: var(--code-bg);
            padding: 1rem;
            border: 1px solid var(--border-color);
            overflow-x: auto;
        }
        
        /* Responsive styles */
        @media (max-width: 768px) {
            .container {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                height: auto;
                position: relative;
                border-right: none;
                border-bottom: 1px solid var(--border-color);
                display: none;
            }
            
            .sidebar.visible {
                display: block;
            }
            
            .content {
                margin-left: 0;
                padding: 1rem;
            }
            
            .sidebar-toggle {
                display: block;
            }
            
            .hybrid-box {
                flex-direction: column;
            }
            
            .hybrid-box-column:first-child {
                border-right: none;
                border-bottom: 1px solid var(--border-color);
            }
        }

        /* Enhanced table styles for better readability */
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 1.5rem 0;
            font-size: 0.95em;
        }

        table.table-corporate th {
            background-color: #A3A3A3;
            color: white;
            font-weight: bold;
            text-align: left;
            padding: 8px 12px;
            border: 1px solid #737373;
        }

        table.table-corporate td {
            padding: 8px 12px;
            border: 1px solid #737373;
            vertical-align: top;
        }

        table.table-corporate tr:nth-child(even) {
            background-color: #F0F0F0;
        }

        table.table-corporate tr:hover {
            background-color: #E8E8E8;
        }

        /* Enhanced code block styles */
        pre {
            margin: 1.5rem 0;
            padding: 1rem;
            background-color: #F5F5F5;
            border: 1px solid #737373;
            overflow-x: auto;
            position: relative;
        }

        pre code {
            font-family: "Courier New", Courier, monospace;
            font-size: 0.9em;
            line-height: 1.4;
            display: block;
            padding-top: 0.5rem; /* Space for buttons */
        }

        /* Improved code buttons */
        .code-buttons {
            position: absolute;
            top: 5px;
            right: 5px;
            display: flex;
            gap: 5px;
            z-index: 10;
        }

        .copy-button, .execute-button {
            background-color: #E5E5E5;
            border: 1px solid #737373;
            padding: 3px 8px;
            font-size: 0.75rem;
            cursor: pointer;
            box-shadow: 1px 1px 0px #A3A3A3;
        }

        .copy-button:hover, .execute-button:hover {
            background-color: #D5D5D5;
        }

        .copy-button:active, .execute-button:active {
            box-shadow: none;
            transform: translate(1px, 1px);
        }

        /* Improved ASCII diagram styles */
        .ascii-diagram {
            font-family: "Courier New", Courier, monospace;
            white-space: pre;
            line-height: 1.2;
            background-color: #F5F5F5;
            padding: 1.5rem;
            border: 1px solid #737373;
            overflow-x: auto;
            margin: 1.5rem 0;
            box-shadow: 2px 2px 0px #A3A3A3;
        }

        /* Improved tag styles for field names */
        .field-tag {
            display: inline-block;
            background-color: #A3A3A3;
            color: white;
            padding: 0.1rem 0.4rem;
            margin: 0 0.2rem;
            font-family: "Courier New", Courier, monospace;
        }

        /* Improved bullet lists with tags */
        ul.field-list {
            list-style-type: none;
            padding-left: 1rem;
        }

        ul.field-list li {
            margin-bottom: 0.5rem;
            position: relative;
            padding-left: 1rem;
        }

        ul.field-list li:before {
            content: "•";
            position: absolute;
            left: 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <button id="sidebarToggle" class="sidebar-toggle">☰</button>
        
        <div id="sidebar" class="sidebar">
            <h2>Table of Contents</h2>
            
            <div class="search-container">
                <input type="text" id="searchInput" class="search-input" placeholder="Search chapters...">
                <div id="searchResults" class="search-results"></div>
            </div>
            
            <ul id="chapterList" class="chapter-list">
                <!-- Chapters will be dynamically loaded here -->
            </ul>
        </div>
        
        <div id="content" class="content">
            <div class="header">
                <h1>Solana Protocol Design for Agent and MCP Server Registries</h1>
                <div class="header-controls">
                    <button id="downloadPDF">Download PDF</button>
                    <button id="printPage">Print</button>
                </div>
            </div>
            
            <div id="spinner" class="spinner">
                <p>Loading chapter...</p>
            </div>
            
            <div id="errorMessage" class="error-message"></div>
            
            <div id="chapterContent"></div>
            
            <div class="navigation-controls">
                <button id="prevChapter">Previous Chapter</button>
                <button id="nextChapter">Next Chapter</button>
            </div>
        </div>
    </div>
    
    <script>
        // Wait for DOM to be fully loaded
        document.addEventListener('DOMContentLoaded', function() {
            // Check if libraries are loaded
            var librariesLoaded = function() {
                return typeof hljs !== 'undefined' && 
                       typeof marked !== 'undefined' && 
                       typeof DOMPurify !== 'undefined';
            };

            // Initialize app when libraries are loaded
            var initializeApp = function() {
                if (librariesLoaded()) {
                    console.log('All libraries loaded, initializing app');
                    initApp();
                } else {
                    console.log('Waiting for libraries to load...');
                    setTimeout(initializeApp, 100);
                }
            };

            // Start checking for libraries
            initializeApp();

            // Main application initialization
            function initApp() {
                // Chapter configuration
                const chapters = [
                    { id: "1", title: "Introduction", file: "research_draft_part1.md" },
                    { id: "2", title: "Foundational Solana Concepts", file: "research_draft_part2.md" },
                    { id: "3", title: "Agent Registry Protocol Design", file: "research_draft_part3.md" },
                    { id: "4", title: "MCP Server Registry Design", file: "research_draft_part4.md" },
                    { id: "5", title: "Discovery and Query Mechanisms", file: "research_draft_part5.md" },
                    { id: "6", title: "Implementation Guidelines", file: "research_draft_part6.md" },
                    { id: "7", title: "Security Considerations", file: "research_draft_part7.md" },
                    { id: "8", title: "Performance Optimizations", file: "research_draft_part8.md" },
                    { id: "9", title: "Deployment and Maintenance", file: "research_draft_part9.md" },
                    { id: "10", title: "Case Studies and Examples", file: "research_draft_part10.md" },
                    { id: "11", title: "Future Directions", file: "research_draft_part11.md" },
                    { id: "12", title: "Conclusion", file: "research_draft_part12.md" },
                    { id: "13", title: "References", file: "research_draft_part13.md" },
                    { id: "14", title: "Appendices", file: "research_draft_part14.md" }
                ];
                
                // Cache for markdown content
                const markdownCache = {};
                
                // Search index
                let searchIndex = [];
                
                // Current chapter
                let currentChapterId = "1";
                
                // DOM elements
                const sidebar = document.getElementById('sidebar');
                const content = document.getElementById('content');
                const chapterList = document.getElementById('chapterList');
                const chapterContent = document.getElementById('chapterContent');
                const spinner = document.getElementById('spinner');
                const errorMessage = document.getElementById('errorMessage');
                const prevChapterButton = document.getElementById('prevChapter');
                const nextChapterButton = document.getElementById('nextChapter');
                const sidebarToggle = document.getElementById('sidebarToggle');
                const downloadPDFButton = document.getElementById('downloadPDF');
                const printPageButton = document.getElementById('printPage');
                const searchInput = document.getElementById('searchInput');
                const searchResults = document.getElementById('searchResults');
                
                // Initialize marked renderer with sanitization
                const renderer = new marked.Renderer();
                
                // Custom renderer for code blocks with syntax highlighting and buttons
                renderer.code = function(code, language) {
                    // Ensure code is a string
                    code = typeof code === 'string' ? code : String(code);
                    
                    // Check if this is an ASCII diagram
                    const isAsciiDiagram = code.includes('+-') || code.includes('|') || code.includes('--') || code.includes('==') || code.includes('[]');
                    
                    if (isAsciiDiagram) {
                        return `<div class="ascii-diagram">${code}</div>`;
                    }
                    
                    // Determine if this is a shell command
                    const isShellCommand = language === 'bash' || language === 'sh' || language === 'shell';
                    
                    // Create code block with buttons
                    let html = '<pre><div class="code-buttons">';
                    html += '<button class="copy-button" onclick="copyCode(this)">Copy</button>';
                    
                    if (isShellCommand) {
                        html += '<button class="execute-button" onclick="executeCode(this)">Execute</button>';
                    }
                    
                    html += '</div><code';
                    
                    if (language) {
                        html += ` class="language-${language}"`;
                    }
                    
                    html += `>${hljs.highlightAuto(code, language ? [language] : undefined).value}</code></pre>`;
                    
                    return html;
                };
                
                // Custom renderer for tables
                renderer.table = function(header, body) {
                    return `<table class="table-corporate">\n<thead>\n${header}</thead>\n<tbody>\n${body}</tbody>\n</table>\n`;
                };
                
                // Set up marked options
                marked.setOptions({
                    renderer: renderer,
                    highlight: function(code, lang) {
                        try {
                            if (typeof hljs !== 'undefined' && lang && hljs.getLanguage(lang)) {
                                return hljs.highlight(code, { language: lang }).value;
                            } else if (typeof hljs !== 'undefined') {
                                return hljs.highlightAuto(code).value;
                            }
                            return code;
                        } catch (e) {
                            console.error('Error highlighting code:', e);
                            return code;
                        }
                    },
                    pedantic: false,
                    gfm: true,
                    breaks: false,
                    sanitize: false,
                    smartLists: true,
                    smartypants: false,
                    xhtml: false
                });
                
                // Initialize the app
                initializeSidebar();
                loadChapter(currentChapterId);
                setupEventListeners();
                
                // Initialize sidebar
                function initializeSidebar() {
                    // Clear chapter list
                    chapterList.innerHTML = '';
                    
                    // Add chapters to sidebar
                    chapters.forEach(chapter => {
                        const li = document.createElement('li');
                        
                        // Add toggle button
                        const toggleButton = document.createElement('span');
                        toggleButton.className = 'chapter-toggle';
                        toggleButton.textContent = '+';
                        toggleButton.dataset.chapterId = chapter.id;
                        toggleButton.addEventListener('click', () => {
                            toggleSubchapters(chapter.id);
                        });
                        li.appendChild(toggleButton);
                        
                        // Add chapter link
                        const a = document.createElement('a');
                        a.href = '#';
                        a.textContent = `${chapter.id}. ${chapter.title}`;
                        a.dataset.chapterId = chapter.id;
                        a.addEventListener('click', (e) => {
                            e.preventDefault();
                            loadChapter(chapter.id);
                        });
                        li.appendChild(a);
                        
                        // Add subchapter list container
                        const subchapterList = document.createElement('ul');
                        subchapterList.className = 'subchapter-list';
                        subchapterList.id = `subchapters-${chapter.id}`;
                        li.appendChild(subchapterList);
                        
                        chapterList.appendChild(li);
                    });
                }
                
                // Toggle subchapters visibility
                function toggleSubchapters(chapterId) {
                    const subchapterList = document.getElementById(`subchapters-${chapterId}`);
                    const toggleButton = document.querySelector(`.chapter-toggle[data-chapter-id="${chapterId}"]`);
                    
                    if (subchapterList.classList.contains('visible')) {
                        subchapterList.classList.remove('visible');
                        toggleButton.textContent = '+';
                    } else {
                        // If no subchapters yet, load them
                        if (subchapterList.children.length === 0) {
                            // If this is not the current chapter, load it first
                            if (currentChapterId !== chapterId) {
                                loadChapter(chapterId, false);
                            } else {
                                // Update subchapters for current chapter
                                updateSubchapters(chapterId, chapterContent);
                            }
                        }
                        
                        subchapterList.classList.add('visible');
                        toggleButton.textContent = '-';
                    }
                }
                
                // Load chapter content
                async function loadChapter(chapterId, updateContent = true) {
                    // Update current chapter
                    if (updateContent) {
                        currentChapterId = chapterId;
                    }
                    
                    // Update active state in sidebar
                    document.querySelectorAll('#chapterList a').forEach(a => {
                        a.classList.remove('active');
                        if (a.dataset.chapterId === chapterId) {
                            a.classList.add('active');
                        }
                    });
                    
                    // Show loading spinner if updating content
                    if (updateContent) {
                        spinner.classList.add('visible');
                        errorMessage.classList.remove('visible');
                        errorMessage.textContent = '';
                    }
                    
                    try {
                        // Get chapter file
                        const chapter = chapters.find(c => c.id === chapterId);
                        if (!chapter) {
                            throw new Error(`Chapter ${chapterId} not found`);
                        }
                        
                        // Check cache first
                        let markdownContent;
                        if (markdownCache[chapter.file]) {
                            markdownContent = markdownCache[chapter.file];
                        } else {
                            // Fetch markdown content
                            const response = await fetch(chapter.file);
                            if (!response.ok) {
                                throw new Error(`Failed to load ${chapter.file}: ${response.status} ${response.statusText}`);
                            }
                            markdownContent = await response.text();
                            
                            // Cache the content
                            markdownCache[chapter.file] = markdownContent;
                            
                            // Add to search index
                            addToSearchIndex(chapterId, chapter.title, markdownContent);
                        }
                        
                        if (updateContent) {
                            // Parse markdown to HTML with sanitization
                            const htmlContent = DOMPurify.sanitize(marked.parse(markdownContent));
                            
                            // Update content
                            chapterContent.innerHTML = htmlContent;
                            
                            // Process ASCII diagrams
                            processAsciiDiagrams();
                            
                            // Update navigation buttons
                            updateNavigationButtons();
                            
                            // Add copy and execute buttons to code blocks
                            addCodeButtons();
                            
                            // Enhance field tags in bullet lists
                            enhanceFieldTags();
                            
                            // Highlight code blocks
                            if (typeof hljs !== 'undefined') {
                                document.querySelectorAll('pre code').forEach((block) => {
                                    try {
                                        hljs.highlightElement(block);
                                    } catch (e) {
                                        console.error('Error highlighting element:', e);
                                    }
                                });
                            } else {
                                console.warn('highlight.js not available for syntax highlighting');
                            }
                        }
                        
                        // Extract subheadings and update sidebar
                        updateSubchapters(chapterId, updateContent ? chapterContent : null);
                        
                        // Expand current chapter in sidebar
                        if (updateContent) {
                            toggleSubchapters(chapterId);
                        }
                        
                    } catch (error) {
                        console.error('Error loading chapter:', error);
                        if (updateContent) {
                            errorMessage.textContent = `Error Loading Chapter\n${error.message}\nPlease ensure all markdown files are in the same directory as this HTML file.\n\nExpected file: ${chapters.find(c => c.id === chapterId).file}`;
                            errorMessage.classList.add('visible');
                        }
                    } finally {
                        // Hide loading spinner
                        if (updateContent) {
                            spinner.classList.remove('visible');
                        }
                    }
                }
                
                // Extract subheadings from chapter content and update sidebar
                function updateSubchapters(chapterId, contentElement) {
                    const subchapterList = document.getElementById(`subchapters-${chapterId}`);
                    if (!subchapterList) return;
                    
                    // Clear existing subchapters
                    subchapterList.innerHTML = '';
                    
                    // If no content element provided, fetch the chapter content
                    if (!contentElement && markdownCache[chapters.find(c => c.id === chapterId).file]) {
                        const markdownContent = markdownCache[chapters.find(c => c.id === chapterId).file];
                        const tempDiv = document.createElement('div');
                        tempDiv.innerHTML = DOMPurify.sanitize(marked.parse(markdownContent));
                        contentElement = tempDiv;
                    }
                    
                    if (!contentElement) return;
                    
                    // Find all h2 and h3 elements in the content
                    const headings = contentElement.querySelectorAll('h2, h3');
                    
                    if (headings.length > 0) {
                        // Add each heading as a subchapter
                        headings.forEach((heading, index) => {
                            // Create an ID for the heading if it doesn't have one
                            if (!heading.id) {
                                heading.id = `section-${chapterId}-${index}`;
                            }
                            
                            const li = document.createElement('li');
                            const a = document.createElement('a');
                            a.href = `#${heading.id}`;
                            a.textContent = heading.textContent;
                            a.addEventListener('click', (e) => {
                                e.preventDefault();
                                
                                // If this is not the current chapter, load it first
                                if (currentChapterId !== chapterId) {
                                    loadChapter(chapterId);
                                }
                                
                                // Then scroll to the heading
                                setTimeout(() => {
                                    document.getElementById(heading.id).scrollIntoView({ behavior: 'smooth' });
                                }, 300);
                            });
                            
                            // Indent h3 elements
                            if (heading.tagName === 'H3') {
                                a.style.paddingLeft = '1rem';
                            }
                            
                            li.appendChild(a);
                            subchapterList.appendChild(li);
                        });
                        
                        // Show the toggle button
                        const toggleButton = document.querySelector(`.chapter-toggle[data-chapter-id="${chapterId}"]`);
                        if (toggleButton) {
                            toggleButton.style.visibility = 'visible';
                        }
                    } else {
                        // Hide the toggle button if no headings
                        const toggleButton = document.querySelector(`.chapter-toggle[data-chapter-id="${chapterId}"]`);
                        if (toggleButton) {
                            toggleButton.style.visibility = 'hidden';
                        }
                    }
                }
                
                // Process ASCII diagrams
                function processAsciiDiagrams() {
                    document.querySelectorAll('.ascii-diagram').forEach(diagram => {
                        // No additional processing needed, the CSS handles the display
                    });
                }
                
                // Update navigation buttons
                function updateNavigationButtons() {
                    const currentIndex = chapters.findIndex(c => c.id === currentChapterId);
                    
                    // Update previous button
                    if (currentIndex > 0) {
                        prevChapterButton.disabled = false;
                        prevChapterButton.onclick = () => loadChapter(chapters[currentIndex - 1].id);
                    } else {
                        prevChapterButton.disabled = true;
                        prevChapterButton.onclick = null;
                    }
                    
                    // Update next button
                    if (currentIndex < chapters.length - 1) {
                        nextChapterButton.disabled = false;
                        nextChapterButton.onclick = () => loadChapter(chapters[currentIndex + 1].id);
                    } else {
                        nextChapterButton.disabled = true;
                        nextChapterButton.onclick = null;
                    }
                }
                
                // Add code buttons
                function addCodeButtons() {
                    document.querySelectorAll('pre').forEach(pre => {
                        // Skip if buttons already exist
                        if (pre.querySelector('.code-buttons')) return;
                        
                        const code = pre.querySelector('code');
                        if (!code) return;
                        
                        const buttonsDiv = document.createElement('div');
                        buttonsDiv.className = 'code-buttons';
                        
                        // Copy button
                        const copyButton = document.createElement('button');
                        copyButton.className = 'copy-button';
                        copyButton.textContent = 'Copy';
                        copyButton.onclick = function() {
                            copyCode(this);
                        };
                        buttonsDiv.appendChild(copyButton);
                        
                        // Execute button for shell commands
                        const isShellCommand = code.className.includes('language-bash') || 
                                             code.className.includes('language-sh') || 
                                             code.className.includes('language-shell');
                        
                        if (isShellCommand) {
                            const executeButton = document.createElement('button');
                            executeButton.className = 'execute-button';
                            executeButton.textContent = 'Execute';
                            executeButton.onclick = function() {
                                executeCode(this);
                            };
                            buttonsDiv.appendChild(executeButton);
                        }
                        
                        pre.insertBefore(buttonsDiv, pre.firstChild);
                    });
                }
                
                // Enhance field tags in bullet lists
                function enhanceFieldTags() {
                    document.querySelectorAll('ul li').forEach(li => {
                        const text = li.innerHTML;
                        
                        // Check if the list item contains field-like patterns
                        if (text.match(/`[a-zA-Z0-9_]+`:/)) {
                            // Convert the pattern to a field tag
                            const enhancedText = text.replace(/`([a-zA-Z0-9_]+)`:/g, '<span class="field-tag">$1</span>:');
                            li.innerHTML = enhancedText;
                            
                            // Add the field-list class to the parent ul if not already present
                            const parentUl = li.parentElement;
                            if (parentUl && !parentUl.classList.contains('field-list')) {
                                parentUl.classList.add('field-list');
                            }
                        }
                    });
                }
                
                // Add to search index
                function addToSearchIndex(chapterId, chapterTitle, markdownContent) {
                    // Create a temporary div to parse the markdown
                    const tempDiv = document.createElement('div');
                    tempDiv.innerHTML = DOMPurify.sanitize(marked.parse(markdownContent));
                    
                    // Extract headings
                    const headings = Array.from(tempDiv.querySelectorAll('h1, h2, h3, h4, h5, h6')).map(heading => {
                        return {
                            chapterId,
                            chapterTitle,
                            text: heading.textContent,
                            type: 'heading',
                            level: parseInt(heading.tagName.substring(1)),
                            id: heading.id || `heading-${chapterId}-${Math.random().toString(36).substring(2, 9)}`
                        };
                    });
                    
                    // Extract paragraphs
                    const paragraphs = Array.from(tempDiv.querySelectorAll('p')).map(p => {
                        return {
                            chapterId,
                            chapterTitle,
                            text: p.textContent,
                            type: 'paragraph'
                        };
                    });
                    
                    // Add to search index
                    searchIndex = searchIndex.concat(headings, paragraphs);
                }
                
                // Search function
                function search(query) {
                    if (!query || query.trim() === '') {
                        searchResults.innerHTML = '';
                        searchResults.classList.remove('visible');
                        return;
                    }
                    
                    const results = searchIndex.filter(item => {
                        return item.text.toLowerCase().includes(query.toLowerCase());
                    });
                    
                    // Display results
                    searchResults.innerHTML = '';
                    
                    if (results.length === 0) {
                        const noResults = document.createElement('div');
                        noResults.className = 'search-result-item';
                        noResults.textContent = 'No results found';
                        searchResults.appendChild(noResults);
                    } else {
                        results.slice(0, 10).forEach(result => {
                            const resultItem = document.createElement('div');
                            resultItem.className = 'search-result-item';
                            
                            // Create result text with highlighted query
                            const text = result.text;
                            const index = text.toLowerCase().indexOf(query.toLowerCase());
                            const highlightedText = text.substring(0, index) + 
                                                  '<strong>' + text.substring(index, index + query.length) + '</strong>' + 
                                                  text.substring(index + query.length);
                            
                            resultItem.innerHTML = `<strong>Chapter ${result.chapterId}:</strong> ${highlightedText}`;
                            
                            resultItem.addEventListener('click', () => {
                                loadChapter(result.chapterId);
                                
                                // If it's a heading, scroll to it
                                if (result.type === 'heading' && result.id) {
                                    setTimeout(() => {
                                        const element = document.getElementById(result.id);
                                        if (element) {
                                            element.scrollIntoView({ behavior: 'smooth' });
                                        }
                                    }, 300);
                                }
                                
                                // Clear search
                                searchInput.value = '';
                                searchResults.innerHTML = '';
                                searchResults.classList.remove('visible');
                            });
                            
                            searchResults.appendChild(resultItem);
                        });
                    }
                    
                    searchResults.classList.add('visible');
                }
                
                // Setup event listeners
                function setupEventListeners() {
                    // Sidebar toggle
                    sidebarToggle.addEventListener('click', () => {
                        sidebar.classList.toggle('sidebar-hidden');
                        content.classList.toggle('content-full');
                    });
                    
                    // Download PDF
                    downloadPDFButton.addEventListener('click', () => {
                        // Open PDF in new tab
                        window.open('solana_protocol_design_for_agent_and_mcp_server_registries.pdf', '_blank');
                    });
                    
                    // Print page
                    printPageButton.addEventListener('click', () => {
                        window.print();
                    });
                    
                    // Search input
                    searchInput.addEventListener('input', () => {
                        search(searchInput.value);
                    });
                    
                    // Keyboard shortcuts
                    document.addEventListener('keydown', (e) => {
                        // Toggle sidebar with 'S' key
                        if (e.key === 's' || e.key === 'S') {
                            if (document.activeElement.tagName !== 'INPUT') {
                                e.preventDefault();
                                sidebar.classList.toggle('sidebar-hidden');
                                content.classList.toggle('content-full');
                            }
                        }
                        
                        // Focus search with '/' key
                        if (e.key === '/') {
                            if (document.activeElement.tagName !== 'INPUT') {
                                e.preventDefault();
                                searchInput.focus();
                            }
                        }
                        
                        // Navigate with arrow keys
                        if (document.activeElement.tagName !== 'INPUT') {
                            const currentIndex = chapters.findIndex(c => c.id === currentChapterId);
                            
                            // Previous chapter with left arrow
                            if (e.key === 'ArrowLeft' && currentIndex > 0) {
                                e.preventDefault();
                                loadChapter(chapters[currentIndex - 1].id);
                            }
                            
                            // Next chapter with right arrow
                            if (e.key === 'ArrowRight' && currentIndex < chapters.length - 1) {
                                e.preventDefault();
                                loadChapter(chapters[currentIndex + 1].id);
                            }
                        }
                    });
                    
                    // Close search results when clicking outside
                    document.addEventListener('click', (e) => {
                        if (!searchInput.contains(e.target) && !searchResults.contains(e.target)) {
                            searchResults.classList.remove('visible');
                        }
                    });
                }
            }
        });

        // Global functions for code buttons
        function copyCode(button) {
            const pre = button.closest('pre');
            const code = pre.querySelector('code');
            const text = code.textContent;
            
            navigator.clipboard.writeText(text).then(() => {
                // Show copied feedback
                const originalText = button.textContent;
                button.textContent = 'Copied!';
                setTimeout(() => {
                    button.textContent = originalText;
                }, 2000);
            }).catch(err => {
                console.error('Failed to copy code:', err);
            });
        }
        
        function executeCode(button) {
            const pre = button.closest('pre');
            const code = pre.querySelector('code');
            const command = code.textContent.trim();
            
            // Open terminal and insert command
            try {
                // This is a simplified approach - in a real environment,
                // you would need to use a more sophisticated method to open a terminal
                const terminal = window.open('', '_blank');
                if (terminal) {
                    terminal.document.write(`<pre>Execute this command in your terminal:\n\n${command}</pre>`);
                    terminal.document.title = 'Terminal Command';
                    terminal.focus();
                } else {
                    alert('Please allow popups to open the terminal');
                }
            } catch (err) {
                console.error('Failed to execute code:', err);
                alert(`Please copy and execute this command in your terminal:\n\n${command}`);
            }
        }
    </script>
</body>
</html>
