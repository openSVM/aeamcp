<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Solana Protocol Design for Agent and MCP Server Registries</title>
    
    <!-- External libraries -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11.8.0/styles/github-gist.min.css">
    <script src="https://cdn.jsdelivr.net/npm/highlight.js@11.8.0/highlight.min.js"></script>
    <!-- Explicitly include Rust language support -->
    <script src="https://cdn.jsdelivr.net/npm/highlight.js@11.8.0/languages/rust.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked@4.3.0/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.5/dist/purify.min.js"></script>
    
    <style>
        /* Base styles */
        :root {
            --bg-color: #f8f8f8;
            --text-color: #333;
            --border-color: #737373;
            --header-bg: #e5e5e5;
            --tag-bg: #a3a3a3;
            --hover-bg: #f0f0f0;
            --code-bg: #f5f5f5;
            --box-shadow: 2px 2px 0px #a3a3a3;
            --info-box-bg: #e5e5e5;
        }
        
        body {
            font-family: "Courier New", Courier, monospace;
            line-height: 1.6;
            margin: 0;
            padding: 0;
            background-color: var(--bg-color);
            color: var(--text-color);
        }
        
        /* Layout */
        .container {
            display: flex;
            min-height: 100vh;
        }
        
        /* Sidebar */
        .sidebar {
            width: 280px;
            background-color: var(--header-bg);
            border-right: 1px solid var(--border-color);
            padding: 1rem;
            overflow-y: auto;
            position: fixed;
            height: 100vh;
            transition: transform 0.3s ease;
            z-index: 100;
        }
        
        .sidebar-hidden {
            transform: translateX(-280px);
        }
        
        .sidebar-toggle {
            position: fixed;
            top: 10px;
            left: 10px;
            z-index: 101;
            background-color: var(--header-bg);
            border: 1px solid var(--border-color);
            padding: 5px 10px;
            cursor: pointer;
            display: none;
        }
        
        .sidebar h2 {
            margin-top: 0;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid var(--border-color);
        }
        
        .search-container {
            margin-bottom: 1rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border-color);
        }
        
        .search-input {
            width: 100%;
            padding: 0.5rem;
            font-family: "Courier New", Courier, monospace;
            border: 1px solid var(--border-color);
            background-color: var(--bg-color);
        }
        
        .search-results {
            margin-top: 0.5rem;
            max-height: 200px;
            overflow-y: auto;
            display: none;
        }
        
        .search-results.visible {
            display: block;
        }
        
        .search-result-item {
            padding: 0.5rem;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
        }
        
        .search-result-item:hover {
            background-color: var(--hover-bg);
        }
        
        .chapter-list {
            list-style-type: none;
            padding: 0;
            margin: 0;
        }
        
        .chapter-list li {
            margin-bottom: 0.5rem;
        }
        
        .chapter-list a {
            display: block;
            padding: 0.5rem;
            text-decoration: none;
            color: var(--text-color);
            border: 1px solid transparent;
        }
        
        .chapter-list a:hover, .chapter-list a.active {
            background-color: var(--hover-bg);
            border: 1px solid var(--border-color);
        }
        
        .chapter-toggle {
            display: inline-block;
            width: 20px;
            text-align: center;
            cursor: pointer;
        }
        
        .subchapter-list {
            list-style-type: none;
            padding-left: 1.5rem;
            margin: 0.5rem 0;
            display: none;
        }
        
        .subchapter-list.visible {
            display: block;
        }
        
        /* Main content */
        .content {
            flex: 1;
            padding: 2rem;
            margin-left: 280px;
            transition: margin-left 0.3s ease;
        }
        
        .content-full {
            margin-left: 0;
        }
        
        /* Header */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 0;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 2rem;
        }
        
        .header h1 {
            margin: 0;
        }
        
        .header-controls {
            display: flex;
            gap: 1rem;
        }
        
        /* Navigation controls */
        .navigation-controls {
            display: flex;
            justify-content: space-between;
            margin-top: 2rem;
            padding-top: 1rem;
            border-top: 1px solid var(--border-color);
        }
        
        /* Loading spinner */
        .spinner {
            display: none;
            margin: 2rem auto;
            text-align: center;
        }
        
        .spinner.visible {
            display: block;
        }
        
        /* Error message */
        .error-message {
            background-color: #ffdddd;
            border: 1px solid #f44336;
            padding: 1rem;
            margin: 1rem 0;
            display: none;
        }
        
        .error-message.visible {
            display: block;
        }
        
        /* Button styles */
        button {
            background-color: var(--header-bg);
            border: 1px solid var(--border-color);
            padding: 0.5rem 1rem;
            cursor: pointer;
            font-family: "Courier New", Courier, monospace;
        }
        
        button:hover {
            background-color: var(--hover-bg);
        }
        
        /* Table styles */
        .table-corporate {
            width: 100%;
            border-collapse: collapse;
            margin: 1rem 0;
        }
        
        .table-corporate th {
            background-color: var(--tag-bg);
            color: white;
            text-align: left;
            padding: 0.5rem;
            border: 1px solid var(--border-color);
        }
        
        .table-corporate td {
            padding: 0.5rem;
            border: 1px solid var(--border-color);
        }
        
        .table-corporate tr:nth-child(even) {
            background-color: var(--hover-bg);
        }
        
        /* Card and info box styles */
        .card {
            background-color: var(--code-bg);
            border: 1px solid var(--border-color);
            padding: 1rem;
            margin: 1rem 0;
            box-shadow: var(--box-shadow);
        }
        
        .info-box {
            background-color: var(--info-box-bg);
            border: 1px dashed var(--border-color);
            padding: 1rem;
            margin: 1rem 0;
        }
        
        /* Hybrid box for two-column layouts */
        .hybrid-box {
            display: flex;
            margin: 1rem 0;
            border: 1px solid var(--border-color);
        }
        
        .hybrid-box-column {
            flex: 1;
            padding: 1rem;
            background-color: var(--code-bg);
        }
        
        .hybrid-box-column:first-child {
            border-right: 1px solid var(--border-color);
        }
        
        .hybrid-box-connector {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0 1rem;
        }
        
        /* Flow steps and arrows */
        .flow-step {
            background-color: var(--code-bg);
            border: 1px solid var(--border-color);
            padding: 0.5rem 1rem;
            margin: 0.5rem 0;
            text-align: center;
        }
        
        .flow-arrow {
            text-align: center;
            margin: 0.5rem 0;
        }
        
        /* Code styles */
        pre {
            background-color: var(--code-bg);
            border: 1px solid var(--border-color);
            padding: 1rem;
            overflow-x: auto;
            position: relative;
            margin: 1rem 0;
        }
        
        code {
            font-family: "Courier New", Courier, monospace;
        }
        
        .code-tag {
            display: inline-block;
            background-color: var(--tag-bg);
            padding: 0.1rem 0.3rem;
            margin: 0 0.2rem;
            border-radius: 0;
        }
        
        /* Code buttons */
        .code-buttons {
            position: absolute;
            top: 5px;
            right: 5px;
            display: flex;
            gap: 5px;
        }
        
        .copy-button, .execute-button {
            background-color: var(--header-bg);
            border: 1px solid var(--border-color);
            padding: 2px 5px;
            font-size: 0.8rem;
            cursor: pointer;
        }
        
        .copy-button:hover, .execute-button:hover {
            background-color: var(--hover-bg);
        }
        
        /* ASCII diagram styles */
        .ascii-diagram {
            font-family: "Courier New", Courier, monospace;
            white-space: pre;
            line-height: 1.2;
            background-color: var(--code-bg);
            padding: 1rem;
            border: 1px solid var(--border-color);
            overflow-x: auto;
        }
        
        /* Responsive styles */
        @media (max-width: 768px) {
            .container {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                height: auto;
                position: relative;
                border-right: none;
                border-bottom: 1px solid var(--border-color);
                display: none;
            }
            
            .sidebar.visible {
                display: block;
            }
            
            .content {
                margin-left: 0;
                padding: 1rem;
            }
            
            .sidebar-toggle {
                display: block;
            }
            
            .hybrid-box {
                flex-direction: column;
            }
            
            .hybrid-box-column:first-child {
                border-right: none;
                border-bottom: 1px solid var(--border-color);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <button id="sidebarToggle" class="sidebar-toggle">☰</button>
        
        <div id="sidebar" class="sidebar">
            <h2>Table of Contents</h2>
            
            <div class="search-container">
                <input type="text" id="searchInput" class="search-input" placeholder="Search chapters...">
                <div id="searchResults" class="search-results"></div>
            </div>
            
            <ul id="chapterList" class="chapter-list">
                <!-- Chapters will be dynamically loaded here -->
            </ul>
        </div>
        
        <div id="content" class="content">
            <div class="header">
                <h1>Solana Protocol Design for Agent and MCP Server Registries</h1>
                <div class="header-controls">
                    <button id="downloadPDF">Download PDF</button>
                    <button id="printPage">Print</button>
                </div>
            </div>
            
            <div id="spinner" class="spinner">
                <p>Loading chapter...</p>
            </div>
            
            <div id="errorMessage" class="error-message"></div>
            
            <div id="chapterContent"></div>
            
            <div class="navigation-controls">
                <button id="prevChapter">Previous Chapter</button>
                <button id="nextChapter">Next Chapter</button>
            </div>
        </div>
    </div>
    
    <script>
        // Chapter configuration
        const chapters = [
            { id: "1", title: "Introduction", file: "research_draft_part1.md" },
            { id: "2", title: "Foundational Solana Concepts", file: "research_draft_part2.md" },
            { id: "3", title: "Agent Registry Protocol Design", file: "research_draft_part3.md" },
            { id: "4", title: "MCP Server Registry Design", file: "research_draft_part4.md" },
            { id: "5", title: "Discovery and Query Mechanisms", file: "research_draft_part5.md" },
            { id: "6", title: "Implementation Guidelines", file: "research_draft_part6.md" },
            { id: "7", title: "Security Considerations", file: "research_draft_part7.md" },
            { id: "8", title: "Performance Optimizations", file: "research_draft_part8.md" },
            { id: "9", title: "Deployment and Maintenance", file: "research_draft_part9.md" },
            { id: "10", title: "Case Studies and Examples", file: "research_draft_part10.md" },
            { id: "11", title: "Future Directions", file: "research_draft_part11.md" },
            { id: "12", title: "Conclusion", file: "research_draft_part12.md" },
            { id: "13", title: "References", file: "research_draft_part13.md" },
            { id: "14", title: "Appendices", file: "research_draft_part14.md" }
        ];
        
        // Cache for markdown content
        const markdownCache = {};
        
        // Search index
        let searchIndex = [];
        
        // Current chapter
        let currentChapterId = "1";
        
        // DOM elements
        const sidebar = document.getElementById('sidebar');
        const content = document.getElementById('content');
        const chapterList = document.getElementById('chapterList');
        const chapterContent = document.getElementById('chapterContent');
        const spinner = document.getElementById('spinner');
        const errorMessage = document.getElementById('errorMessage');
        const prevChapterButton = document.getElementById('prevChapter');
        const nextChapterButton = document.getElementById('nextChapter');
        const sidebarToggle = document.getElementById('sidebarToggle');
        const downloadPDFButton = document.getElementById('downloadPDF');
        const printPageButton = document.getElementById('printPage');
        const searchInput = document.getElementById('searchInput');
        const searchResults = document.getElementById('searchResults');
        
        // Initialize marked renderer with sanitization
        const renderer = new marked.Renderer();
        
        // Custom renderer for code blocks with syntax highlighting and buttons
        renderer.code = function(code, language) {
            const validLanguage = typeof language === 'string' ? language : '';
            const isShellCommand = validLanguage === 'bash' || validLanguage === 'sh';
            const highlightedCode = hljs.highlightAuto(code, validLanguage ? [validLanguage] : undefined).value;
            
            // Check if this is an ASCII diagram (contains box drawing characters)
            const isAsciiDiagram = typeof code === 'string' && (
                code.includes('┌') || code.includes('└') || code.includes('┐') || code.includes('┘') ||
                code.includes('+---') || code.includes('|') || code.includes('+-') ||
                code.includes('-->') || code.includes('<--') || code.includes('<->') ||
                code.includes('===') || code.includes('---')
            );
            
            let result = '';
            
            if (isAsciiDiagram) {
                result = `<div class="ascii-diagram">${code}</div>`;
            } else {
                result = `<pre><div class="code-buttons">
                    <button class="copy-button" onclick="copyCode(this)">Copy</button>
                    ${isShellCommand ? '<button class="execute-button" onclick="executeCode(this)">Execute</button>' : ''}
                </div><code class="${validLanguage}">${highlightedCode}</code></pre>`;
            }
            
            return result;
        };
        
        // Custom renderer for list items to handle tag-style elements
        renderer.listitem = function(text) {
            // Replace patterns like `keyword` with tag-style spans
            const taggedText = text.replace(/`([^`]+)`/g, '<span class="code-tag">$1</span>');
            return `<li>${taggedText}</li>`;
        };
        
        // Set up marked with custom renderer and sanitization
        marked.setOptions({
            renderer: renderer,
            highlight: function(code, lang) {
                if (lang && hljs.getLanguage(lang)) {
                    return hljs.highlight(code, { language: lang }).value;
                }
                return hljs.highlightAuto(code).value;
            },
            breaks: true,
            gfm: true
        });
        
        // Initialize the sidebar with chapters
        function initializeSidebar() {
            chapterList.innerHTML = '';
            
            chapters.forEach(chapter => {
                const li = document.createElement('li');
                
                // Create chapter toggle button
                const toggleSpan = document.createElement('span');
                toggleSpan.className = 'chapter-toggle';
                toggleSpan.textContent = '+';
                toggleSpan.dataset.chapterId = chapter.id;
                toggleSpan.addEventListener('click', (e) => {
                    e.stopPropagation();
                    toggleSubchapters(chapter.id);
                });
                li.appendChild(toggleSpan);
                
                // Create chapter link
                const a = document.createElement('a');
                a.href = `#chapter-${chapter.id}`;
                a.textContent = `${chapter.id}. ${chapter.title}`;
                a.dataset.chapterId = chapter.id;
                a.style.display = 'inline-block';
                a.style.width = 'calc(100% - 25px)';
                a.addEventListener('click', (e) => {
                    e.preventDefault();
                    loadChapter(chapter.id);
                });
                li.appendChild(a);
                
                // Create subchapter list container
                const subchapterList = document.createElement('ul');
                subchapterList.className = 'subchapter-list';
                subchapterList.id = `subchapters-${chapter.id}`;
                li.appendChild(subchapterList);
                
                chapterList.appendChild(li);
            });
        }
        
        // Toggle subchapters visibility
        function toggleSubchapters(chapterId) {
            const subchapterList = document.getElementById(`subchapters-${chapterId}`);
            const toggleButton = document.querySelector(`.chapter-toggle[data-chapter-id="${chapterId}"]`);
            
            if (subchapterList.classList.contains('visible')) {
                subchapterList.classList.remove('visible');
                toggleButton.textContent = '+';
            } else {
                // If no subchapters yet, load them
                if (subchapterList.children.length === 0) {
                    // If this is not the current chapter, load it first
                    if (currentChapterId !== chapterId) {
                        loadChapter(chapterId, false);
                    } else {
                        // Update subchapters for current chapter
                        updateSubchapters(chapterId, chapterContent);
                    }
                }
                
                subchapterList.classList.add('visible');
                toggleButton.textContent = '-';
            }
        }
        
        // Load chapter content
        async function loadChapter(chapterId, updateContent = true) {
            // Update current chapter
            if (updateContent) {
                currentChapterId = chapterId;
            }
            
            // Update active state in sidebar
            document.querySelectorAll('#chapterList a').forEach(a => {
                a.classList.remove('active');
                if (a.dataset.chapterId === chapterId) {
                    a.classList.add('active');
                }
            });
            
            // Show loading spinner if updating content
            if (updateContent) {
                spinner.classList.add('visible');
                errorMessage.classList.remove('visible');
                errorMessage.textContent = '';
            }
            
            try {
                // Get chapter file
                const chapter = chapters.find(c => c.id === chapterId);
                if (!chapter) {
                    throw new Error(`Chapter ${chapterId} not found`);
                }
                
                // Check cache first
                let markdownContent;
                if (markdownCache[chapter.file]) {
                    markdownContent = markdownCache[chapter.file];
                } else {
                    // Fetch markdown content
                    const response = await fetch(chapter.file);
                    if (!response.ok) {
                        throw new Error(`Failed to load ${chapter.file}: ${response.status} ${response.statusText}`);
                    }
                    markdownContent = await response.text();
                    
                    // Cache the content
                    markdownCache[chapter.file] = markdownContent;
                    
                    // Add to search index
                    addToSearchIndex(chapterId, chapter.title, markdownContent);
                }
                
                if (updateContent) {
                    // Parse markdown to HTML with sanitization
                    const htmlContent = DOMPurify.sanitize(marked.parse(markdownContent));
                    
                    // Update content
                    chapterContent.innerHTML = htmlContent;
                    
                    // Process ASCII diagrams
                    processAsciiDiagrams();
                    
                    // Update navigation buttons
                    updateNavigationButtons();
                    
                    // Add copy and execute buttons to code blocks
                    addCodeButtons();
                    
                    // Highlight code blocks
                    document.querySelectorAll('pre code').forEach((block) => {
                        hljs.highlightElement(block);
                    });
                }
                
                // Extract subheadings and update sidebar
                updateSubchapters(chapterId, updateContent ? chapterContent : null);
                
            } catch (error) {
                console.error('Error loading chapter:', error);
                if (updateContent) {
                    errorMessage.textContent = `Error Loading Chapter\n${error.message}\nPlease ensure all markdown files are in the same directory as this HTML file.\n\nExpected file: ${chapters.find(c => c.id === chapterId).file}`;
                    errorMessage.classList.add('visible');
                }
            } finally {
                // Hide loading spinner
                if (updateContent) {
                    spinner.classList.remove('visible');
                }
            }
        }
        
        // Extract subheadings from chapter content and update sidebar
        function updateSubchapters(chapterId, contentElement) {
            const subchapterList = document.getElementById(`subchapters-${chapterId}`);
            if (!subchapterList) return;
            
            // Clear existing subchapters
            subchapterList.innerHTML = '';
            
            // If no content element provided, fetch the chapter content
            if (!contentElement && markdownCache[chapters.find(c => c.id === chapterId).file]) {
                const markdownContent = markdownCache[chapters.find(c => c.id === chapterId).file];
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = DOMPurify.sanitize(marked.parse(markdownContent));
                contentElement = tempDiv;
            }
            
            if (!contentElement) return;
            
            // Find all h2 and h3 elements in the content
            const headings = contentElement.querySelectorAll('h2, h3');
            
            if (headings.length > 0) {
                // Add each heading as a subchapter
                headings.forEach((heading, index) => {
                    // Create an ID for the heading if it doesn't have one
                    if (!heading.id) {
                        heading.id = `section-${chapterId}-${index}`;
                    }
                    
                    const li = document.createElement('li');
                    const a = document.createElement('a');
                    a.href = `#${heading.id}`;
                    a.textContent = heading.textContent;
                    a.addEventListener('click', (e) => {
                        e.preventDefault();
                        
                        // If this is not the current chapter, load it first
                        if (currentChapterId !== chapterId) {
                            loadChapter(chapterId);
                        }
                        
                        // Then scroll to the heading
                        setTimeout(() => {
                            document.getElementById(heading.id).scrollIntoView({ behavior: 'smooth' });
                        }, 300);
                    });
                    
                    // Indent h3 elements
                    if (heading.tagName === 'H3') {
                        a.style.paddingLeft = '1rem';
                    }
                    
                    li.appendChild(a);
                    subchapterList.appendChild(li);
                });
                
                // Show the toggle button
                const toggleButton = document.querySelector(`.chapter-toggle[data-chapter-id="${chapterId}"]`);
                if (toggleButton) {
                    toggleButton.style.visibility = 'visible';
                }
            } else {
                // Hide the toggle button if no headings
                const toggleButton = document.querySelector(`.chapter-toggle[data-chapter-id="${chapterId}"]`);
                if (toggleButton) {
                    toggleButton.style.visibility = 'hidden';
                }
            }
        }
        
        // Process ASCII diagrams
        function processAsciiDiagrams() {
            document.querySelectorAll('.ascii-diagram').forEach(diagram => {
                // No additional processing needed, the CSS handles the display
            });
        }
        
        // Update navigation buttons
        function updateNavigationButtons() {
            const currentIndex = chapters.findIndex(c => c.id === currentChapterId);
            
            // Previous button
            if (currentIndex > 0) {
                prevChapterButton.disabled = false;
                prevChapterButton.onclick = () => loadChapter(chapters[currentIndex - 1].id);
            } else {
                prevChapterButton.disabled = true;
                prevChapterButton.onclick = null;
            }
            
            // Next button
            if (currentIndex < chapters.length - 1) {
                nextChapterButton.disabled = false;
                nextChapterButton.onclick = () => loadChapter(chapters[currentIndex + 1].id);
            } else {
                nextChapterButton.disabled = true;
                nextChapterButton.onclick = null;
            }
        }
        
        // Add copy and execute buttons to code blocks
        function addCodeButtons() {
            document.querySelectorAll('pre').forEach(pre => {
                // Skip if buttons already exist
                if (pre.querySelector('.code-buttons')) return;
                
                const codeElement = pre.querySelector('code');
                if (!codeElement) return;
                
                const language = Array.from(codeElement.classList).find(cls => cls !== 'hljs');
                const isShellCommand = language === 'bash' || language === 'sh';
                
                const buttonsDiv = document.createElement('div');
                buttonsDiv.className = 'code-buttons';
                
                const copyButton = document.createElement('button');
                copyButton.className = 'copy-button';
                copyButton.textContent = 'Copy';
                copyButton.onclick = function() { copyCode(this); };
                buttonsDiv.appendChild(copyButton);
                
                if (isShellCommand) {
                    const executeButton = document.createElement('button');
                    executeButton.className = 'execute-button';
                    executeButton.textContent = 'Execute';
                    executeButton.onclick = function() { executeCode(this); };
                    buttonsDiv.appendChild(executeButton);
                }
                
                pre.insertBefore(buttonsDiv, pre.firstChild);
            });
        }
        
        // Copy code to clipboard
        function copyCode(button) {
            const pre = button.closest('pre');
            const code = pre.querySelector('code');
            const text = code.textContent;
            
            navigator.clipboard.writeText(text).then(() => {
                const originalText = button.textContent;
                button.textContent = 'Copied!';
                setTimeout(() => {
                    button.textContent = originalText;
                }, 2000);
            }).catch(err => {
                console.error('Failed to copy code:', err);
                alert('Failed to copy code to clipboard');
            });
        }
        
        // Execute code in terminal
        function executeCode(button) {
            const pre = button.closest('pre');
            const code = pre.querySelector('code');
            const command = code.textContent;
            
            try {
                // Create a temporary textarea to hold the command
                const textarea = document.createElement('textarea');
                textarea.value = command;
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
                
                // Attempt to open terminal with the command
                alert('Command copied to clipboard. Please paste it in your terminal.');
                
                // On some systems, we can try to open a terminal
                // This may not work in all browsers due to security restrictions
                if (navigator.platform.indexOf('Win') !== -1) {
                    // Windows
                    window.open('cmd://');
                } else if (navigator.platform.indexOf('Mac') !== -1) {
                    // macOS
                    window.open('terminal://');
                } else {
                    // Linux and others
                    window.open('x-terminal-emulator://');
                }
            } catch (err) {
                console.error('Failed to execute code:', err);
                alert('Command copied to clipboard. Please open a terminal and paste the command.');
            }
        }
        
        // Toggle sidebar
        function toggleSidebar() {
            sidebar.classList.toggle('sidebar-hidden');
            content.classList.toggle('content-full');
        }
        
        // Download PDF
        function downloadPDF() {
            // Redirect to the PDF file
            window.open('solana_protocol_design_for_agent_and_mcp_server_registries.pdf', '_blank');
        }
        
        // Print page
        function printPage() {
            window.print();
        }
        
        // Add to search index
        function addToSearchIndex(chapterId, chapterTitle, markdownContent) {
            // Add chapter title
            searchIndex.push({
                chapterId: chapterId,
                title: chapterTitle,
                content: chapterTitle,
                isTitle: true
            });
            
            // Extract headings from markdown
            const headingRegex = /^(#{2,3})\s+(.+)$/gm;
            let match;
            
            while ((match = headingRegex.exec(markdownContent)) !== null) {
                const level = match[1].length; // Number of # characters
                const heading = match[2].trim();
                
                searchIndex.push({
                    chapterId: chapterId,
                    title: `${chapterId}.${level-1} ${heading}`,
                    content: heading,
                    isTitle: false,
                    level: level
                });
            }
            
            // Extract paragraphs for content search
            const paragraphs = markdownContent.split('\n\n');
            paragraphs.forEach((paragraph, index) => {
                // Skip headings and code blocks
                if (!paragraph.startsWith('#') && !paragraph.startsWith('```')) {
                    // Clean up the paragraph
                    const cleanParagraph = paragraph
                        .replace(/\n/g, ' ')
                        .replace(/\*\*/g, '')
                        .replace(/\*/g, '')
                        .replace(/`/g, '')
                        .trim();
                    
                    if (cleanParagraph.length > 20) { // Only index substantial paragraphs
                        searchIndex.push({
                            chapterId: chapterId,
                            title: `${chapterTitle} - Paragraph ${index + 1}`,
                            content: cleanParagraph,
                            isTitle: false,
                            isParagraph: true
                        });
                    }
                }
            });
        }
        
        // Perform search
        function performSearch(query) {
            if (!query || query.length < 2) {
                searchResults.innerHTML = '';
                searchResults.classList.remove('visible');
                return;
            }
            
            const results = searchIndex.filter(item => {
                return item.content.toLowerCase().includes(query.toLowerCase());
            });
            
            // Sort results: chapter titles first, then headings, then paragraphs
            results.sort((a, b) => {
                if (a.isTitle && !b.isTitle) return -1;
                if (!a.isTitle && b.isTitle) return 1;
                if (a.level && b.level) return a.level - b.level;
                if (a.isParagraph && !b.isParagraph) return 1;
                if (!a.isParagraph && b.isParagraph) return -1;
                return 0;
            });
            
            // Limit to top 10 results
            const limitedResults = results.slice(0, 10);
            
            if (limitedResults.length > 0) {
                searchResults.innerHTML = '';
                
                limitedResults.forEach(result => {
                    const resultItem = document.createElement('div');
                    resultItem.className = 'search-result-item';
                    
                    // Highlight the matching text
                    const regex = new RegExp(`(${query})`, 'gi');
                    const highlightedContent = result.isTitle ? 
                        result.content.replace(regex, '<strong>$1</strong>') :
                        result.content.substring(0, 100).replace(regex, '<strong>$1</strong>') + '...';
                    
                    resultItem.innerHTML = highlightedContent;
                    resultItem.addEventListener('click', () => {
                        loadChapter(result.chapterId);
                        searchResults.classList.remove('visible');
                        searchInput.value = '';
                    });
                    
                    searchResults.appendChild(resultItem);
                });
                
                searchResults.classList.add('visible');
            } else {
                searchResults.innerHTML = '<div class="search-result-item">No results found</div>';
                searchResults.classList.add('visible');
            }
        }
        
        // Handle keyboard navigation
        function handleKeydown(event) {
            // Left arrow key for previous chapter
            if (event.key === 'ArrowLeft' && !prevChapterButton.disabled) {
                prevChapterButton.click();
            }
            
            // Right arrow key for next chapter
            if (event.key === 'ArrowRight' && !nextChapterButton.disabled) {
                nextChapterButton.click();
            }
            
            // 'S' key to toggle sidebar
            if (event.key === 's' || event.key === 'S') {
                toggleSidebar();
            }
            
            // '/' key to focus search
            if (event.key === '/') {
                searchInput.focus();
                event.preventDefault();
            }
        }
        
        // Initialize the application
        function initialize() {
            // Initialize sidebar
            initializeSidebar();
            
            // Set up event listeners
            sidebarToggle.addEventListener('click', toggleSidebar);
            downloadPDFButton.addEventListener('click', downloadPDF);
            printPageButton.addEventListener('click', printPage);
            document.addEventListener('keydown', handleKeydown);
            
            // Set up search
            searchInput.addEventListener('input', () => {
                performSearch(searchInput.value);
            });
            
            // Close search results when clicking outside
            document.addEventListener('click', (e) => {
                if (!searchResults.contains(e.target) && e.target !== searchInput) {
                    searchResults.classList.remove('visible');
                }
            });
            
            // Load the first chapter
            loadChapter(currentChapterId);
            
            // Handle window resize
            window.addEventListener('resize', () => {
                if (window.innerWidth > 768) {
                    sidebar.classList.remove('sidebar-hidden');
                    content.classList.remove('content-full');
                }
            });
        }
        
        // Start the application when the DOM is loaded
        document.addEventListener('DOMContentLoaded', initialize);
        
        // Make functions available globally
        window.copyCode = copyCode;
        window.executeCode = executeCode;
        window.toggleSubchapters = toggleSubchapters;
    </script>
</body>
</html>
